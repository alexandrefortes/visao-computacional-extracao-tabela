<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>‚ÄúOCR‚Äù com LLMs</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="stock-extract-clean_files/libs/clipboard/clipboard.min.js"></script>
<script src="stock-extract-clean_files/libs/quarto-html/quarto.js"></script>
<script src="stock-extract-clean_files/libs/quarto-html/popper.min.js"></script>
<script src="stock-extract-clean_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="stock-extract-clean_files/libs/quarto-html/anchor.min.js"></script>
<link href="stock-extract-clean_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="stock-extract-clean_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="stock-extract-clean_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="stock-extract-clean_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="stock-extract-clean_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">‚ÄúOCR‚Äù com LLMs</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="o-que-esse-c√≥digo-faz" class="level2">
<h2 class="anchored" data-anchor-id="o-que-esse-c√≥digo-faz">O que esse c√≥digo faz</h2>
<ul>
<li>Extrai a tabela da imagem e converte em dataframe.</li>
<li>Ordenar o DataFrame pela coluna variacao em ordem crescente.<br>
</li>
<li>Iniciar um loop para alocar o or√ßamento para comprar lotes de 100 a√ß√µes de cada tipo, seguindo a ordem do DataFrame ordenado.<br>
</li>
<li>Continuar o looping at√© que o or√ßamento seja insuficiente para qqr compra de lote.</li>
</ul>
</section>
<section id="checklist" class="level2">
<h2 class="anchored" data-anchor-id="checklist">Checklist</h2>
<ol type="1">
<li><strong>Cria√ß√£o da chave de API</strong><br>
</li>
<li><strong>Preparo da imagem</strong><br>
</li>
<li><strong>Requisi√ß√£o √† Vision API</strong><br>
</li>
<li><strong>Processar a resposta</strong><br>
</li>
<li><strong>[<code>melhoria</code>] Enviar no prompt um dicion√°rio de a√ß√µes</strong><br>
</li>
<li><strong>[<code>melhoria</code>] Mudar a l√≥gica de ordena√ß√£o para varia√ß√£o pre√ßo-atual -&gt; pre√ßo-teto seguido de varia√ß√£o</strong></li>
<li><strong>[<code>melhoria</code>] Considerar % de aloca√ß√£o atual vs aloca√ß√£o recomendada nas defini√ß√µes de compra</strong></li>
<li><strong>[<code>melhoria avan√ßada</code>] An√°lise de balanceamento de carteira</strong></li>
<li><strong>[<code>melhoria avan√ßada</code>] Crawler em casas de an√°lise com extra√ß√£o de HTML ou Print para comparar estrat√©gias</strong></li>
</ol>
</section>
<section id="observa√ß√µes" class="level2">
<h2 class="anchored" data-anchor-id="observa√ß√µes">Observa√ß√µes</h2>
<ul>
<li>Modelo usado: <code>gpt-4-vision-preview</code> <a href="https://platform.openai.com/docs/guides/vision">Documenta√ß√£o Vision: https://platform.openai.com/docs/guides/vision</a></li>
<li>Ele pode se comportar diferente do ChatGPT pois a OpenAI tem um sistema de mensagens que inserem automaticamente no backend.</li>
<li>√â o mesmo modelo que o GPT-4 Turbo, com a habilidade adicional de vis√£o computacional.</li>
<li>As imagens podem ser enviadas de 2 formas: link da imagem ou codificada em base64 diretamente na requisi√ß√£o.</li>
<li>Busca de prompt m√≠nimo, de forma que a aplica√ß√£o fique o mais ampla poss√≠vel.</li>
</ul>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># amostra de imagem</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Image, display</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>display(Image(filename<span class="op">=</span><span class="st">'SmalCaps.png'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="stock-extract-clean_files/figure-html/cell-2-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> base64</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>load_dotenv(dotenv_path<span class="op">=</span><span class="st">'.env'</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>api_key <span class="op">=</span> os.getenv(<span class="st">"OPENAI_API_KEY_VISAO"</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> encode_image(image_path):</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">with</span> <span class="bu">open</span>(image_path, <span class="st">"rb"</span>) <span class="im">as</span> image_file:</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> base64.b64encode(image_file.read()).decode(<span class="st">'utf-8'</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>image_path <span class="op">=</span> <span class="st">"SmalCaps.png"</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>base64_image <span class="op">=</span> encode_image(image_path)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> OpenAI(api_key<span class="op">=</span>api_key)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> passa_visao(instructions):</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  response <span class="op">=</span> client.chat.completions.create(</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"gpt-4-vision-preview"</span>,</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    messages<span class="op">=</span>[</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>      {</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"role"</span>: <span class="st">"user"</span>,</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"content"</span>: [</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>          {<span class="st">"type"</span>: <span class="st">"text"</span>, <span class="st">"text"</span>: instructions},</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>          {</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">"type"</span>: <span class="st">"image_url"</span>,</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>            <span class="st">"image_url"</span>: {</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>              <span class="st">"url"</span>: <span class="ss">f"data:image/jpeg;base64,</span><span class="sc">{</span>base64_image<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>              <span class="st">"detail"</span>: <span class="st">"high"</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>          },</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span><span class="dv">4000</span>,</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> response</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Com erro gramatical e com "You dont need to interpret, just list." ü§î</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>instructions <span class="op">=</span> <span class="st">"I understand that you, as the advanced GPT-4 model with vision capabilities, are well-equipped for this task. Could you check the image for any stock-related information? Additionally, I would appreciate if you could organize the extracted data about the stocks into a JSON format. Need all 'Stock 1', 'Stock 2', 'Stock 3', 'Stock 4', 'Stock 5', 'Stock 6', 'Stock 7', 'Stock 8', 'Stock 9', 'Stock 10', 'Stock 11', 'Stock 12', 'Stock 13', 'Stock 14', etc. You dont need to interpret, just list. I suggest the following template for each stock  </span><span class="ch">\"</span><span class="st">Stock 1</span><span class="ch">\"</span><span class="st">: {</span><span class="ch">\"</span><span class="st">ticker</span><span class="ch">\"</span><span class="st">: </span><span class="ch">\"</span><span class="st">FIGE3</span><span class="ch">\"</span><span class="st">,    </span><span class="ch">\"</span><span class="st">entrada</span><span class="ch">\"</span><span class="st">: </span><span class="ch">\"</span><span class="st">3.87</span><span class="ch">\"</span><span class="st">,    </span><span class="ch">\"</span><span class="st">data_entrada</span><span class="ch">\"</span><span class="st">: </span><span class="ch">\"</span><span class="st">13.07.2022</span><span class="ch">\"</span><span class="st">,    </span><span class="ch">\"</span><span class="st">preco_atual</span><span class="ch">\"</span><span class="st">: </span><span class="ch">\"</span><span class="st">3.74</span><span class="ch">\"</span><span class="st">,    </span><span class="ch">\"</span><span class="st">variacao</span><span class="ch">\"</span><span class="st">: </span><span class="ch">\"</span><span class="st">-0.53%</span><span class="ch">\"</span><span class="st">,    </span><span class="ch">\"</span><span class="st">preco_teto</span><span class="ch">\"</span><span class="st">: </span><span class="ch">\"</span><span class="st">4.95</span><span class="ch">\"</span><span class="st">,    </span><span class="ch">\"</span><span class="st">alocacao</span><span class="ch">\"</span><span class="st">: </span><span class="ch">\"</span><span class="st">10.0%</span><span class="ch">\"</span><span class="st">,    </span><span class="ch">\"</span><span class="st">rentabilidade</span><span class="ch">\"</span><span class="st">: </span><span class="ch">\"</span><span class="st">-3.36%</span><span class="ch">\"</span><span class="st">,    </span><span class="ch">\"</span><span class="st">vi√©s</span><span class="ch">\"</span><span class="st">: </span><span class="ch">\"</span><span class="st">Comprar</span><span class="ch">\"</span><span class="st">  }. Considerando que quanto menor o campo varia√ß√£o maior a oportunidade. Liste as que possuem o campo Vi√©s igual a </span><span class="ch">\"</span><span class="st">Comprar</span><span class="ch">\"</span><span class="st">. Your answer showld have only the main JSON, with the stocks. Do not add instroduction or end texts (like </span><span class="ch">\"</span><span class="st">Based on the criteria described...</span><span class="ch">\"</span><span class="st"> or </span><span class="ch">\"</span><span class="st">organized in the format you requested.</span><span class="ch">\"</span><span class="st">)."</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>complete_response <span class="op">=</span> passa_visao(instructions)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(complete_response.choices[<span class="dv">0</span>].message.content)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>```json
{
  "Stock 1": {
    "ticker": "FIGE3",
    "entrada": "3.87",
    "data_entrada": "13.07.2022",
    "preco_atual": "3.74",
    "variacao": "-0.53%",
    "preco_teto": "4.95",
    "alocacao": "10.0%",
    "rentabilidade": "-3.36%",
    "vi√©s": "Comprar"
  },
  "Stock 3": {
    "ticker": "ALSO3",
    "entrada": "23.33",
    "data_entrada": "02.05.2018",
    "preco_atual": "24.65",
    "variacao": "-0.08%",
    "preco_teto": "30.00",
    "alocacao": "10.0%",
    "rentabilidade": "5.66%",
    "vi√©s": "Comprar"
  },
  "Stock 4": {
    "ticker": "RECV3",
    "entrada": "15.79",
    "data_entrada": "08.09.2021",
    "preco_atual": "22.06",
    "variacao": "-4.34%",
    "preco_teto": "24.14",
    "alocacao": "7.5%",
    "rentabilidade": "39.71%",
    "vi√©s": "Comprar"
  },
  "Stock 6": {
    "ticker": "MLAS3",
    "entrada": "6.71",
    "data_entrada": "01.12.2021",
    "preco_atual": "1.93",
    "variacao": "-1.53%",
    "preco_teto": "4.20",
    "alocacao": "7.5%",
    "rentabilidade": "-71.24%",
    "vi√©s": "Comprar"
  },
  "Stock 8": {
    "ticker": "FESA4",
    "entrada": "4.48",
    "data_entrada": "01.07.2019",
    "preco_atual": "10.02",
    "variacao": "-1.57%",
    "preco_teto": "11.00",
    "alocacao": "7.5%",
    "rentabilidade": "123.66%",
    "vi√©s": "Comprar"
  },
  "Stock 9": {
    "ticker": "TRIS3",
    "entrada": "2.13",
    "data_entrada": "11.09.2018",
    "preco_atual": "4.65",
    "variacao": "-0.43%",
    "preco_teto": "8.00",
    "alocacao": "6.5%",
    "rentabilidade": "118.31%",
    "vi√©s": "Comprar"
  },
  "Stock 10": {
    "ticker": "SOJA3",
    "entrada": "9.90",
    "data_entrada": "29.04.2021",
    "preco_atual": "15.24",
    "variacao": "-0.85%",
    "preco_teto": "16.50",
    "alocacao": "7.5%",
    "rentabilidade": "53.94%",
    "vi√©s": "Comprar"
  },
  "Stock 12": {
    "ticker": "BRBI11",
    "entrada": "18.68",
    "data_entrada": "06.07.2021",
    "preco_atual": "15.96",
    "variacao": "-2.62%",
    "preco_teto": "18.00",
    "alocacao": "5.0%",
    "rentabilidade": "-14.56%",
    "vi√©s": "Comprar"
  },
  "Stock 14": {
    "ticker": "G2DT3",
    "entrada": "7.20",
    "data_entrada": "04.08.2021",
    "preco_atual": "1.97",
    "variacao": "2.07%",
    "preco_teto": "2.00",
    "alocacao": "2.5%",
    "rentabilidade": "-72.64%",
    "vi√©s": "Comprar"
  }
}
```</code></pre>
</div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json  </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>json_str <span class="op">=</span> complete_response.choices[<span class="dv">0</span>].message.content.replace(<span class="st">"```json"</span>, <span class="st">""</span>).replace(<span class="st">"```"</span>, <span class="st">""</span>).strip()</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>data_dict <span class="op">=</span> json.loads(json_str)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>data_list <span class="op">=</span> <span class="bu">list</span>(data_dict.values())</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(data_list)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   ticker entrada data_entrada preco_atual variacao preco_teto alocacao  \
0   FIGE3    3.87   13.07.2022        3.74   -0.53%       4.95    10.0%   
1   ALSO3   23.33   02.05.2018       24.65   -0.08%      30.00    10.0%   
2   RECV3   15.79   08.09.2021       22.06   -4.34%      24.14     7.5%   
3   MLAS3    6.71   01.12.2021        1.93   -1.53%       4.20     7.5%   
4   FESA4    4.48   01.07.2019       10.02   -1.57%      11.00     7.5%   
5   TRIS3    2.13   11.09.2018        4.65   -0.43%       8.00     6.5%   
6   SOJA3    9.90   29.04.2021       15.24   -0.85%      16.50     7.5%   
7  BRBI11   18.68   06.07.2021       15.96   -2.62%      18.00     5.0%   
8   G2DT3    7.20   04.08.2021        1.97    2.07%       2.00     2.5%   

  rentabilidade     vi√©s  
0        -3.36%  Comprar  
1         5.66%  Comprar  
2        39.71%  Comprar  
3       -71.24%  Comprar  
4       123.66%  Comprar  
5       118.31%  Comprar  
6        53.94%  Comprar  
7       -14.56%  Comprar  
8       -72.64%  Comprar  </code></pre>
</div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df_comprar <span class="op">=</span> df[df[<span class="st">"vi√©s"</span>] <span class="op">==</span> <span class="st">"Comprar"</span>]</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_comprar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   ticker entrada data_entrada preco_atual variacao preco_teto alocacao  \
0   FIGE3    3.87   13.07.2022        3.74   -0.53%       4.95    10.0%   
1   ALSO3   23.33   02.05.2018       24.65   -0.08%      30.00    10.0%   
2   RECV3   15.79   08.09.2021       22.06   -4.34%      24.14     7.5%   
3   MLAS3    6.71   01.12.2021        1.93   -1.53%       4.20     7.5%   
4   FESA4    4.48   01.07.2019       10.02   -1.57%      11.00     7.5%   
5   TRIS3    2.13   11.09.2018        4.65   -0.43%       8.00     6.5%   
6   SOJA3    9.90   29.04.2021       15.24   -0.85%      16.50     7.5%   
7  BRBI11   18.68   06.07.2021       15.96   -2.62%      18.00     5.0%   
8   G2DT3    7.20   04.08.2021        1.97    2.07%       2.00     2.5%   

  rentabilidade     vi√©s  
0        -3.36%  Comprar  
1         5.66%  Comprar  
2        39.71%  Comprar  
3       -71.24%  Comprar  
4       123.66%  Comprar  
5       118.31%  Comprar  
6        53.94%  Comprar  
7       -14.56%  Comprar  
8       -72.64%  Comprar  </code></pre>
</div>
</div>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pre√ßo atualiza... pra dps...üîö</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>ticker <span class="op">=</span> <span class="st">"FIQE3.SA"</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>stock <span class="op">=</span> yf.Ticker(ticker)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>hist <span class="op">=</span> stock.history(period<span class="op">=</span><span class="st">"1d"</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(hist[<span class="st">'Close'</span>].iloc[<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>4.139999866485596</code></pre>
</div>
</div>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>budget <span class="op">=</span> <span class="dv">15000</span>  <span class="co"># valor do or√ßamento para compra das a√ß√µes </span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>df_comprar <span class="op">=</span> df[df[<span class="st">"vi√©s"</span>] <span class="op">==</span> <span class="st">"Comprar"</span>].copy()  </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>df_comprar[<span class="st">'variacao'</span>] <span class="op">=</span> df_comprar[<span class="st">'variacao'</span>].<span class="bu">str</span>.replace(<span class="st">'%'</span>, <span class="st">''</span>).astype(<span class="bu">float</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>df_sorted <span class="op">=</span> df_comprar.sort_values(<span class="st">'variacao'</span>, ascending<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>compras <span class="op">=</span> {ticker: <span class="dv">0</span> <span class="cf">for</span> ticker <span class="kw">in</span> df_sorted[<span class="st">'ticker'</span>]}</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop para alocar o or√ßamento em lotes de 100 a√ß√µes</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> budget <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="kw">not</span> df_sorted.empty:</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ticker <span class="kw">in</span> df_sorted[<span class="st">'ticker'</span>]:</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        preco_pacote <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> <span class="bu">float</span>(df_sorted.loc[df_sorted[<span class="st">'ticker'</span>] <span class="op">==</span> ticker, <span class="st">'preco_atual'</span>].iloc[<span class="dv">0</span>])</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> budget <span class="op">&gt;=</span> preco_pacote:</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>            budget <span class="op">-=</span> preco_pacote  </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>            compras[ticker] <span class="op">+=</span> <span class="dv">1</span>  </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>            df_sorted <span class="op">=</span> df_sorted[df_sorted[<span class="st">'ticker'</span>] <span class="op">!=</span> ticker]  <span class="co"># eita, essa n√£o d√° mais</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ticker, pacotes <span class="kw">in</span> compras.items():</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    df_comprar.loc[df_comprar[<span class="st">'ticker'</span>] <span class="op">==</span> ticker, <span class="st">'lotes_comprados'</span>] <span class="op">=</span> pacotes</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_comprar)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Budget restante:"</span>, budget)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   ticker entrada data_entrada preco_atual  variacao preco_teto alocacao  \
0   FIGE3    3.87   13.07.2022        3.74     -0.53       4.95    10.0%   
1   ALSO3   23.33   02.05.2018       24.65     -0.08      30.00    10.0%   
2   RECV3   15.79   08.09.2021       22.06     -4.34      24.14     7.5%   
3   MLAS3    6.71   01.12.2021        1.93     -1.53       4.20     7.5%   
4   FESA4    4.48   01.07.2019       10.02     -1.57      11.00     7.5%   
5   TRIS3    2.13   11.09.2018        4.65     -0.43       8.00     6.5%   
6   SOJA3    9.90   29.04.2021       15.24     -0.85      16.50     7.5%   
7  BRBI11   18.68   06.07.2021       15.96     -2.62      18.00     5.0%   
8   G2DT3    7.20   04.08.2021        1.97      2.07       2.00     2.5%   

  rentabilidade     vi√©s  lotes_comprados  
0        -3.36%  Comprar              1.0  
1         5.66%  Comprar              1.0  
2        39.71%  Comprar              2.0  
3       -71.24%  Comprar              1.0  
4       123.66%  Comprar              2.0  
5       118.31%  Comprar              1.0  
6        53.94%  Comprar              1.0  
7       -14.56%  Comprar              2.0  
8       -72.64%  Comprar              1.0  
Budget restante: 174.0</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>